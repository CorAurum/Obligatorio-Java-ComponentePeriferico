<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Registrar Documento Clínico</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light p-4">
<div class="container">
    <h2 class="mb-4">Registrar Documento Clínico</h2>
    <form method="post" action="/documentos/add" class="p-4 bg-white rounded shadow-sm">

        <!-- Usuario (paciente) -->
        <div class="mb-3">
            <label class="form-label">Paciente</label>
            <select name="cedulaUsuario" class="form-select" required>
                <option value="">Seleccione un paciente</option>
                <option th:each="u : ${usuarios}"
                        th:value="${u.cedulaIdentidad}"
                        th:text="${u.nombre + ' ' + u.apellido + ' (' + u.cedulaIdentidad + ')'}"></option>
            </select>
        </div>

        <!-- Profesional -->
        <div class="mb-3">
            <label class="form-label">Profesional</label>
            <select name="idProfesional" class="form-select" required>
                <option value="">Seleccione un profesional</option>
                <option th:each="prof : ${profesionales}"
                        th:value="${prof.idProfesional}"
                        th:text="${prof.nombre + ' ' + prof.apellido}"></option>
            </select>
        </div>

        <!-- Motivo -->
        <div class="form-group">
            <label for="motivoInput">Motivo</label>
            <input type="text" id="motivoInput" name="motivo" class="form-control" placeholder="Escriba para buscar..." autocomplete="off">
            <div id="motivoDropdown" class="dropdown-menu" style="display:none; max-height:200px; overflow-y:auto;"></div>
        </div>



        <!-- Estado -->
        <div class="mb-3">
            <label class="form-label">Estado del problema</label>
            <select name="idEstado" class="form-select" required>
                <option value="">Seleccione un estado</option>
                <option th:each="e : ${estados}"
                        th:value="${e.id}"
                        th:text="${e.estadoProblema}"></option>
            </select>
        </div>

        <!-- Grado de Certeza -->
        <div class="mb-3">
            <label class="form-label">Grado de Certeza</label>
            <select name="idGradoCerteza" class="form-select" required>
                <option value="">Seleccione un grado</option>
                <option th:each="g : ${gradosCerteza}"
                        th:value="${g.id}"
                        th:text="${g.gradoCerteza}"></option>
            </select>
        </div>

        <!-- Botón -->
        <button type="submit" class="btn btn-primary">Registrar Documento</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('motivoInput');
        const dropdown = document.getElementById('motivoDropdown');

        let timeout = null;

        input.addEventListener('input', () => {
            const query = input.value.trim();
            clearTimeout(timeout);

            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            timeout = setTimeout(() => {
                fetch(`/api/motivos/buscar?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        dropdown.innerHTML = '';
                        if (data.length === 0) {
                            dropdown.style.display = 'none';
                            return;
                        }
                        data.forEach(m => {
                            const item = document.createElement('div');
                            item.className = 'dropdown-item';
                            item.textContent = m.motivo;
                            item.addEventListener('click', () => {
                                input.value = m.motivo;
                                dropdown.style.display = 'none';
                            });
                            dropdown.appendChild(item);
                        });
                        dropdown.style.display = 'block';
                        dropdown.style.position = 'absolute';
                        dropdown.style.width = input.offsetWidth + 'px';
                    });
            }, 300); // pequeño debounce
        });

        document.addEventListener('click', e => {
            if (!dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
            }
        });
    });
</script>


</body>


</html>
